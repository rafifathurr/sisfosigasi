<script>
    $(document).ready(function() {
        $('#min_age_request, #max_age_request').on('change', function() {
            let minAge = parseInt($('#min_age_request').val())
            let maxAge = parseInt($('#max_age_request').val())

            if (minAge > 100) {
                alert('Umur Minimal tidak boleh lebih dari 100.')
                $('#min_age_request').val('')
            }

            if (maxAge > 100) {
                alert('Umur Maksimal tidak boleh lebih dari 100.')
                $('#max_age_request').val('')
            }

            if (!isNaN(minAge) && !isNaN(maxAge)) {
                if (minAge >= maxAge) {
                    alert('Umur Maksimal harus lebih besar dari Umur Minimal.')
                    $('#max_age_request').val('')
                }
            }
        });

        $('#save-btn').on('click', function() {
            let actionType = $(this).data('action')
            storeOrUpdate(actionType)
        });

        $(function() {

            $('#datatables').DataTable({
                processing: true,
                serverSide: true,
                ajax: '{{ route('age-vulnerability-classification.index') }}',
                columns: [{
                        data: 'DT_RowIndex',
                        name: 'DT_RowIndex'
                    },
                    {
                        data: 'name',
                        name: 'Nama'
                    },
                    {
                        data: 'min_year',
                        name: 'Umur Minimal'
                    },
                    {
                        data: 'max_year',
                        name: 'Umur Maksimal'
                    },
                    {
                        data: 'action',
                        name: 'action',
                        class: 'text-center'
                    }
                ]
            })
        })
    });

    function crudAction(actionType, id = null) {
        if (actionType == 'create') {

            $('#modal_name').text('Buat Klasifikasi Kerentanan Umur')
            $('#name_request').val('')
            $('#min_age_request').val('')
            $('#max_age_request').val('')
            $('#save-btn').data('action', 'store')
            $('#create-modal').modal('show')
        } else if (actionType == 'edit') {

            $.ajax({
                type: "GET",
                data: {
                    'id': id
                },
                url: "{{ route('age-vulnerability-classification.show') }}",
                success: function(response) {

                    $('#name_request').val(response.name)
                    $('#min_age_request').val(response.min_year)
                    $('#max_age_request').val(response.max_year)
                    $('#save-btn').data('id', id)
                }
            });
            $('#modal_name').text('Edit Klasifikasi Kerentanan Umur')
            $('#save-btn').data('action', 'update')
            $('#create-modal').modal('show')
        } else if (actionType == 'delete') {

            if (confirm('Are you sure you want to delete this classification?')) {

                $.ajax({
                    url: '{{ route('age-vulnerability-classification.delete') }}',
                    type: 'POST',
                    data: {
                        id: id,
                        _token: '{{ csrf_token() }}'
                    },
                    success: function(response) {
                        alert('Data berhasil dihapus')
                        location.reload()
                        // $('#datatables').DataTable().ajax.reload();
                    },
                    error: function(xhr) {
                        alert('Something went wrong. Please try again.')
                    }
                });
            }
        }
    }

    function storeOrUpdate(actionType) {

        let id = $('#save-btn').data('id')
        let minAge = parseInt($('#min_age_request').val())
        let maxAge = parseInt($('#max_age_request').val())
        let name = $('#name_request').val()

        if (isNaN(minAge) || isNaN(maxAge) || name.trim() === '') {

            alert('Min Age, Max Age, dan Name tidak boleh kosong!')
            return
        }

        let url = (actionType === 'store') ? '{{ route('age-vulnerability-classification.store') }}' :
            '{{ route('age-vulnerability-classification.update') }}'

        $.ajax({
            url: url,
            type: 'POST',
            data: {
                id: id,
                name: name,
                min_age: minAge,
                max_age: maxAge,
                _token: '{{ csrf_token() }}'
            },
            success: function(response) {

                $('#create-modal').modal('hide')
                location.reload()

            },
            error: function(xhr) {
                alert('Something went wrong. Please try again.')
            }
        });
    }

    function checkLastAge(age) {

        $.ajax({
            type: "GET",
            url: "{{ route('age-vulnerability-classification.checkLastAge') }}",
            success: function(response) {

                if (age <= response.max_year) {

                    alert('Umur Tidak Boleh kurang dari ' + response.max_year)
                    $('#min_age_request').val('')
                }
            }
        });
    }
</script>
